---
title: "Counting reads"
author: "Ilyes Baali"
date: "3/6/2021"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Counting reads}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

## Exon Counts
```{r exonFeatureCounts script, eval=FALSE}

#! /bin/bash -l
#SBATCH --partition=angsd_class #SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --job-name=ExonCounts
#SBATCH --time=24:00:00 # HH/MM/SS
#SBATCH --mem=8G 
outFile=ExonCounts_${SLURM_JOB_ID}.txt
echo "Starting at:" `date` >> ${outFile}
echo "This is job #:" $SLURM_JOB_ID >> ${outFile}
echo "Running on node:" `hostname` >> ${outFile}
echo "Running on cluster:" $SLURM_CLUSTER_NAME >> ${outFile}
echo "This job was assigned the temporary (local) directory:" $TMPDIR >> ${outFile}

# load tools
spack load subread

# specify input/output files
GTF=/home/ilb4001/angsd/hw5/STAR/sacCer3.gtf
COUNTFILE=exonCounts_Gierlinski_genes.txt 
Alignment_DIR=/home/frd2007/ANGSD_2019/alignment
# Run featureCounts
featureCounts -a ${GTF} \
              -o ${COUNTFILE} \
              -t 'exon' \
	            -f \
              --verbose \
              ${Alignment_DIR}/*.bam
exit

```

Two parameters that were set: 

1. `-t`: This is used to specify the features for read counting
2. `-f`: This is used to perform read counting at feature level
3. `-O`: Assigns reads to all their overlapping meta-features or features specified by -f flag, i.e if a read overlaps with different features that read, will contribute to the total count of each of these features, hence, the reads with `Unassigned_Ambiguity` will be zero. This parameter was not set in my experiment, but I realized that setting this flag would result in the exons count file similar to the one used to plot the example for this question. 

## Plot Summary

```{r, hide=TRUE}
library(ggplot2) 
library(magrittr)
library(tidyr)

# counting_reads/featCounts_Gierlinski_genes.txt.summary file from /home/frd2007/ANGSD_2019/counting_reads/ folder

genes_summary <-  read.table("counting_reads/featCounts_Gierlinski_genes.txt.summary", header=TRUE)
exons_summary <-  read.table("featCounts_Gierlinski_exons_v1.txt.summary", header=TRUE)
orig_names <- names(genes_summary)

names(genes_summary) <- gsub(".*(WT|SNF2)(_[0-9]+).*", "\\1\\2", orig_names)
names(exons_summary) <- gsub(".*(WT|SNF2)(_[0-9]+).*", "\\1\\2", orig_names)

genes_summary$feature <- 'gene_count'
exons_summary$feature <- 'exon_count'

summary <- rbind(genes_summary, exons_summary)

# transform the data frame to the proper format
summary <- gather(data = summary,
  key = samples,
  value = `#read`,
  SNF2_1:WT_5
)

summary <- summary[summary$`#read` > 0,]
```

```{r plot, fig.width=10, fig.height=7}
p <- ggplot(summary, aes( x = `#read`, y = samples,  fill=Status))+ geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = 'bottom') + labs(title = "Plots based on featureCount summary file", subtitle="featureCounts was run in 2 modes: 1) counting reads per genes, 2) counting reads per exons")

p <- p + facet_grid(feature ~ . ) 

p

```


#### Observations

1. Increase in the number of unassigned reads due to the ambiguity of the exon that overlaps with a given read. This is mostly due to the reads that map to two or more exons.
2. Consequent to the first observation, the number of assigned reads decreased. However, unassigned reads due to the absence of a matching feature stayed the same as expected.
3. Looking at the total read count for the two conditions, we see that SNF2 has more reads (47548232) overall comapred to WT (39976987).

## Features in Mus Musculus GTF Annotation File

I downloaded the GTF annotation file for the mouse model _Mus Musculus_ from [Ensembl](http://ftp.ensembl.org/pub/release-103/gtf/mus_musculus/).

The following command was used to determine the different feature types and their count in the file

```{bash, eval=FALSE}
cat Mus_musculus.GRCm39.103.gtf | egrep -v '#' | cut -d $'\t' -f 3 | sort | uniq -c
```

```
## 528040 CDS
##   65 Selenocysteine
## 840401 exon
## 95397 five_prime_utr
## 53700 gene
## 59981 start_codon
## 55735 stop_codon
## 87210 three_prime_utr
## 140725 transcript
```
